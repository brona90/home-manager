name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  CACHIX_CACHE: gfoster

jobs:
  check:
    name: Flake Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
      - uses: cachix/cachix-action@v15
        with:
          name: nix-community
          extraPullNames: emacs
      - run: nix flake check 2>&1 | grep -v "could not update mtime"

  docker-build:
    name: Build & Push Docker
    runs-on: ubuntu-latest
    needs: check
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
      - uses: cachix/cachix-action@v15
        with:
          name: ${{ env.CACHIX_CACHE }}
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          extraPullNames: nix-community,emacs
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
      - name: Build Docker image
        run: |
          nix build .#dockerImage 2>&1 | grep -v "could not update mtime" || true
          docker load < result
      - name: Push to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u brona90 --password-stdin
          docker tag brona90/terminal:latest brona90/terminal:$(date +%Y%m%d)
          docker push brona90/terminal:latest
          docker push brona90/terminal:$(date +%Y%m%d)

  docker-test:
    name: Test Docker Image
    runs-on: ubuntu-latest
    needs: docker-build
    steps:
      - name: Pull and test image
        run: |
          echo "Pulling fresh image from Docker Hub..."
          docker pull brona90/terminal:latest
          
          echo "Testing tools..."
          docker run --rm brona90/terminal:latest zsh -c "
            echo '=== Tool Check ==='
            which tmux && echo '✓ tmux'
            which emacs && echo '✓ emacs'
            which starship && echo '✓ starship'
            which mise && echo '✓ mise'
            which lvim && echo '✓ lvim'
            which fzf && echo '✓ fzf'
            which rg && echo '✓ ripgrep'
            which fd && echo '✓ fd'
            which eza && echo '✓ eza'
            which bat && echo '✓ bat'
            which zoxide && echo '✓ zoxide'
            echo '=== All tools available ==='
          "

  validate-nixos:
    name: Validate NixOS
    runs-on: ubuntu-latest
    needs: check
    timeout-minutes: 30
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
      - uses: cachix/cachix-action@v15
        with:
          name: ${{ env.CACHIX_CACHE }}
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          extraPullNames: nix-community,emacs
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
      - name: Build NixOS configuration
        run: nix build .#nixosConfigurations.nixos.config.system.build.toplevel 2>&1 | grep -v "could not update mtime" || true
