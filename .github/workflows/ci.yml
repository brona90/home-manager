name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  check:
    name: Flake Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
      - uses: cachix/cachix-action@v15
        with:
          name: nix-community
          extraPullNames: emacs
      - run: nix flake check --show-trace

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: check
    strategy:
      fail-fast: false
      matrix:
        include:
          - type: home
            config: gfoster@x86_64-linux
          - type: nixos
            config: nixos
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
      - uses: cachix/cachix-action@v15
        with:
          name: nix-community
          extraPullNames: emacs
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
      - name: Build ${{ matrix.type }} (${{ matrix.config }})
        run: |
          if [ "${{ matrix.type }}" = "home" ]; then
            nix build .#homeConfigurations."${{ matrix.config }}".activationPackage --show-trace
          else
            nix build .#nixosConfigurations."${{ matrix.config }}".config.system.build.toplevel --show-trace
          fi

  docker:
    name: Docker
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
      - uses: cachix/cachix-action@v15
        with:
          name: nix-community
          extraPullNames: emacs
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
      - uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build, test, and push
        run: |
          nix build .#dockerImage --show-trace
          docker load < result
          docker tag brona90/terminal:latest brona90/terminal:$(date +%Y%m%d)
          
          # Test
          docker run --rm brona90/terminal:latest zsh -c "
            which tmux && which emacs && which starship && echo 'âœ“ All tools available'
          "
          
          # Push
          docker push brona90/terminal:latest
          docker push brona90/terminal:$(date +%Y%m%d)
