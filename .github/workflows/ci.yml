name: CI

on:
  push:
    # Both branches listed for fork-friendliness (repo uses master)
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: read

# Fork-friendly: Use repository variables or fall back to defaults
# Forkers can set these in Settings → Secrets and variables → Actions → Variables
env:
  CACHIX_CACHE: ${{ vars.CACHIX_CACHE || 'gfoster' }}
  DOCKER_USERNAME: ${{ vars.DOCKER_USERNAME || 'brona90' }}

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
      - name: Run statix
        run: nix run nixpkgs#statix -- check .
      - name: Run deadnix
        run: nix run nixpkgs#deadnix -- -f .

  check:
    name: Flake Check
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
      - uses: cachix/cachix-action@v15
        with:
          name: nix-community
          extraPullNames: emacs
      - run: nix flake check 2>&1 | grep -v "could not update mtime"

  build-home:
    name: Build Home Configurations
    runs-on: ubuntu-latest
    needs: check
    # Run on push to main/master (not PRs) to populate cache
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    strategy:
      matrix:
        config:
          - gfoster@x86_64-linux
          # aarch64 configs can't be built on x86 runners
          # - 888973@aarch64-darwin
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
      
      # This job PUSHES to cachix (has authToken)
      - uses: cachix/cachix-action@v15
        with:
          name: ${{ env.CACHIX_CACHE }}
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          extraPullNames: nix-community,emacs
      
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
      
      - name: Build home configuration
        run: |
          echo "Building homeConfigurations.${{ matrix.config }}"
          nix build '.#homeConfigurations."${{ matrix.config }}".activationPackage' 2>&1 | grep -v "could not update mtime" || true
          echo "Build complete - artifacts pushed to cachix automatically"

  docker-build:
    name: Build & Push Docker
    runs-on: ubuntu-latest
    needs: build-home  # Run after home configs cached
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}
    # Only run on push to main/master (not PRs)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
      
      # Read-only: pull from caches but don't push (Docker images bloat cachix)
      - uses: cachix/cachix-action@v15
        with:
          name: ${{ env.CACHIX_CACHE }}
          extraPullNames: nix-community,emacs
      
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
      
      - name: Generate image tag
        id: tag
        run: echo "tag=$(date +%Y%m%d)-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
      
      - name: Build Docker image
        run: |
          nix build .#dockerImage 2>&1 | grep -v "could not update mtime" || true
          docker load < result
      
      - name: Push to Docker Hub
        env:
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          IMAGE_TAG: ${{ steps.tag.outputs.tag }}
        run: |
          if [ -z "$DOCKERHUB_TOKEN" ]; then
            echo "::notice::Skipping Docker Hub push - DOCKERHUB_TOKEN not configured"
            echo "To enable Docker push, add DOCKERHUB_TOKEN secret in repository settings"
            exit 0
          fi
          
          IMAGE="${{ env.DOCKER_USERNAME }}/terminal"
          
          echo "$DOCKERHUB_TOKEN" | docker login -u "${{ env.DOCKER_USERNAME }}" --password-stdin
          docker tag "$IMAGE:latest" "$IMAGE:$IMAGE_TAG"
          docker push "$IMAGE:latest"
          docker push "$IMAGE:$IMAGE_TAG"
          
          echo "::notice::Pushed $IMAGE:$IMAGE_TAG and $IMAGE:latest"

  docker-test:
    name: Test Docker Image
    runs-on: ubuntu-latest
    needs: docker-build
    steps:
      - name: Pull and test image
        env:
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          IMAGE_TAG: ${{ needs.docker-build.outputs.image_tag }}
        run: |
          if [ -z "$DOCKERHUB_TOKEN" ]; then
            echo "::notice::Skipping Docker test - no image was pushed"
            exit 0
          fi
          
          IMAGE="${{ env.DOCKER_USERNAME }}/terminal:$IMAGE_TAG"
          
          echo "Pulling image: $IMAGE"
          docker pull "$IMAGE"
          
          echo "=== Testing tools exist ==="
          docker run --rm "$IMAGE" zsh -c "
            which tmux && echo '✓ tmux'
            which emacs && echo '✓ emacs'
            which starship && echo '✓ starship'
            which mise && echo '✓ mise'
            which lvim && echo '✓ lvim'
            which fzf && echo '✓ fzf'
            which rg && echo '✓ ripgrep'
            which fd && echo '✓ fd'
            which bat && echo '✓ bat'
            which btop && echo '✓ btop'
          "
          
          echo "=== Testing shell loads ==="
          docker run --rm "$IMAGE" zsh -i -c "echo 'Shell loaded successfully'"
          
          echo "=== All tests passed ==="

  validate-nixos:
    name: Validate NixOS
    runs-on: ubuntu-latest
    needs: check
    timeout-minutes: 30
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
      
      # Read-only: pull from caches but don't push
      - uses: cachix/cachix-action@v15
        with:
          name: ${{ env.CACHIX_CACHE }}
          extraPullNames: nix-community,emacs
      
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
      
      - name: Build NixOS configuration
        run: nix build .#nixosConfigurations.nixos.config.system.build.toplevel 2>&1 | grep -v "could not update mtime" || true
