name: Validate

on:
  workflow_dispatch:

permissions:
  contents: read

# Fork-friendly: Use repository variables or fall back to defaults
env:
  CACHIX_CACHE: ${{ vars.CACHIX_CACHE || 'gfoster' }}

jobs:
  nixos:
    name: NixOS
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
      # authToken intentionally included: manual validation builds are
      # worth caching so subsequent CI runs and local builds benefit.
      - uses: cachix/cachix-action@v15
        with:
          name: ${{ env.CACHIX_CACHE }}
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          extraPullNames: nix-community,emacs
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
      - name: Build NixOS configuration
        run: nix build .#nixosConfigurations.nixos.config.system.build.toplevel 2>&1 | grep -v "could not update mtime" || true

  darwin:
    name: Darwin (Apple Silicon)
    runs-on: macos-14
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
      - uses: cachix/cachix-action@v15
        with:
          name: nix-community
          extraPullNames: emacs
      - name: Find Darwin configuration
        id: config
        run: |
          # List available homeConfigurations and find one for aarch64-darwin
          CONFIGS=$(nix flake show --json 2>/dev/null | jq -r '.homeConfigurations | keys[]' 2>/dev/null || echo "")
          DARWIN_CONFIG=$(echo "$CONFIGS" | grep 'aarch64-darwin' | head -1)
          
          if [ -z "$DARWIN_CONFIG" ]; then
            echo "No aarch64-darwin configuration found"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Found: $DARWIN_CONFIG"
            echo "config=$DARWIN_CONFIG" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      - name: Build Darwin configuration
        if: steps.config.outputs.skip != 'true'
        run: |
          CONFIG="${{ steps.config.outputs.config }}"
          echo "Building: $CONFIG"
          nix build ".#homeConfigurations.\"$CONFIG\".activationPackage" 2>&1 | grep -v "could not update mtime" || true
      - name: Skip (no Darwin config)
        if: steps.config.outputs.skip == 'true'
        run: echo "::notice::No aarch64-darwin configuration found in flake, skipping"
